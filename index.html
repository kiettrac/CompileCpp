<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh bi√™n d·ªãch C/C++ Online (CodeMirror)</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.css">

    <style>
        /* --- CSS C∆° b·∫£n --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; /* X√≥a margin m·∫∑c ƒë·ªãnh */
            padding: 15px;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Chi·ªÅu cao t·ªëi thi·ªÉu b·∫±ng m√†n h√¨nh */
            box-sizing: border-box; /* Padding kh√¥ng l√†m tƒÉng k√≠ch th∆∞·ªõc */
        }

        .container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex-grow: 1; /* Chi·∫øm kh√¥ng gian c√≤n l·∫°i */
            display: flex;
            flex-direction: column;
            max-width: 1200px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông */
            width: 100%; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông ƒë·∫øn max-width */
            margin: 0 auto; /* CƒÉn gi·ªØa container */
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #1d2129;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        /* --- Khu v·ª±c ƒëi·ªÅu khi·ªÉn --- */
        .controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
         .control-group-right {
            display: flex;
            align-items: center;
            gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t b√™n ph·∫£i */
         }

        label {
            font-weight: 600;
            color: #4b4f56;
            font-size: 0.95em;
        }

        select, button {
            padding: 9px 14px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            background-color: #f5f6f7;
        }
        select:focus, button:focus {
             outline: none;
             border-color: #007bff;
             box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        select {
             min-width: 90px;
             appearance: none; /* ·∫®n giao di·ªán m·∫∑c ƒë·ªãnh */
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
             background-repeat: no-repeat;
             background-position: right 10px top 50%;
             background-size: .65em auto;
             padding-right: 30px; /* T·∫°o kh√¥ng gian cho m≈©i t√™n */
        }
        select:hover {
            border-color: #adb5bd;
        }

        button {
            color: white;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: 500;
        }

        #runButton {
             background-color: #28a745; /* M√†u xanh l√° */
        }
        #runButton:hover:not(:disabled) {
            background-color: #218838;
        }

        #clearButton {
            background-color: #6c757d; /* M√†u x√°m */
            color: white;
        }
         #clearButton:hover:not(:disabled) {
            background-color: #5a6268;
        }

        button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- Tr√¨nh so·∫°n th·∫£o CodeMirror --- */
        .editor-container {
            margin-bottom: 20px;
            flex-grow: 1;
            display: flex; /* C·∫ßn thi·∫øt ƒë·ªÉ CodeMirror c√≥ th·ªÉ fill height 100% */
            min-height: 300px; /* Chi·ªÅu cao t·ªëi thi·ªÉu */
            position: relative; /* Cho c√°c ph·∫ßn t·ª≠ con ƒë·ªãnh v·ªã tuy·ªát ƒë·ªëi n·∫øu c·∫ßn */
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            overflow: hidden; /* ƒê·∫£m b·∫£o bo tr√≤n ƒë∆∞·ª£c √°p d·ª•ng cho n·ªôi dung b√™n trong */
            background-color: #282a36; /* *** NEW: ƒê·∫∑t m√†u n·ªÅn Dracula cho container *** */
        }

        .CodeMirror {
            /* Kh√¥ng c·∫ßn set border ·ªü ƒë√¢y v√¨ ƒë√£ c√≥ ·ªü container */
            /* Kh√¥ng c·∫ßn set background ·ªü ƒë√¢y n·ªØa v√¨ container ƒë√£ c√≥ */
            border-radius: 0; /* B·ªè radius ·ªü ƒë√¢y ƒë·ªÉ kh√¥ng xung ƒë·ªôt v·ªõi container */
            font-size: 14px;
            height: 100% !important; /* Quan tr·ªçng: ƒê·ªÉ CodeMirror fill container */
            flex-grow: 1; /* ƒê·ªÉ n√≥ chi·∫øm h·∫øt kh√¥ng gian flex trong container */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            /* Ensure CodeMirror itself doesn't have a background that might override the container's */
             background-color: transparent !important; /* ƒê·∫£m b·∫£o n·ªÅn trong su·ªët ƒë·ªÉ th·∫•y n·ªÅn container */
        }

        /* Style cho gutter (s·ªë d√≤ng) - Generic */
        .CodeMirror-gutters {
            /* Remove default light background to allow theme background */
            background-color: transparent; /* B·ªè m√†u n·ªÅn m·∫∑c ƒë·ªãnh */
            border-right: 1px solid #44475a; /* ƒêi·ªÅu ch·ªânh m√†u border gutter cho h·ª£p theme t·ªëi */
        }
        .CodeMirror-linenumber {
            color: #6272a4; /* M√†u s·ªë d√≤ng m·∫∑c ƒë·ªãnh c·ªßa Dracula */
            padding: 0 5px 0 10px !important; /* CƒÉn l·ªÅ s·ªë d√≤ng */
        }

        /* Theme Dracula Specific Overrides (n·∫øu c·∫ßn) */
        .cm-s-dracula { /* √Åp d·ª•ng cho to√†n b·ªô editor khi theme l√† dracula */
             color: #f8f8f2; /* M√†u ch·ªØ ch√≠nh c·ªßa Dracula */
        }
        /* Gutter c·ªßa Dracula */
        .cm-s-dracula .CodeMirror-gutters {
             background: #282a36 !important; /* ƒê·∫£m b·∫£o gutter c√≥ n·ªÅn Dracula */
             border-right: 0px; /* Theme Dracula kh√¥ng c√≥ border ph·∫£i ·ªü gutter */
        }
        .cm-s-dracula .CodeMirror-linenumber {
             color: #6D8A88; /* M√†u s·ªë d√≤ng c·ª• th·ªÉ c·ªßa Dracula */
        }
        /* C√°c m√†u syntax highlighting kh√°c c·ªßa Dracula s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng t·ª´ dracula.min.css */


        /* --- Khu v·ª±c Output --- */
        .output-container {
            margin-top: 15px; /* Kho·∫£ng c√°ch v·ªõi editor */
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            background-color: #f5f6f7;
            display: flex;
            flex-direction: column;
            min-height: 100px; /* Chi·ªÅu cao t·ªëi thi·ªÉu output */
        }

        .output-header {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-bottom: 1px solid #ccd0d5;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }

        .output-header h3 {
            margin: 0;
            font-size: 1em;
            font-weight: 600;
            color: #4b4f56;
        }

        #output {
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background-color: #1e1e1e; /* M√†u n·ªÅn t·ªëi cho output */
            color: #d4d4d4;      /* M√†u ch·ªØ s√°ng */
            flex-grow: 1; /* Chi·∫øm kh√¥ng gian trong container */
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            overflow-x: auto;
            font-size: 0.9em;
            line-height: 1.5;
        }
        #output.error-output {
            color: #ff7b72; /* M√†u ƒë·ªè nh·∫°t cho l·ªói */
        }
        #output.invalid-version-error {
            color: #ffd700; /* M√†u v√†ng ƒë·∫≠m cho c·∫£nh b√°o version */
            background-color: #3a3a2b;
        }

        /* --- Th√¥ng b√°o tr·∫°ng th√°i --- */
        #statusMessage {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-size: 0.9em;
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            text-align: center;
        }
        #statusMessage.info {
            background-color: #e7f3ff;
            color: #00529b;
            border: 1px solid #b8d7ff;
        }
        #statusMessage.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        #statusMessage.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* --- Spinner --- */
        .loader {
            width: 16px;
            height: 16px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: none; /* ·∫®n ban ƒë·∫ßu */
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        button.running .loader {
            display: inline-block; /* Hi·ªán khi ƒëang ch·∫°y */
        }
        button.running .run-icon {
            display: none; /* ·∫®n icon play khi ƒëang ch·∫°y */
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Footer --- */
        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 0.85em;
            color: #606770;
        }
        .footer p {
            margin: 5px 0;
        }
        .footer a {
            color: #007bff;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        .author {
            font-weight: bold;
        }
        .api-note {
             font-size: 0.9em;
        }
         .runtime-warning {
             font-style: italic;
             color: #888;
         }

         /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch; /* C√°c control group chi·∫øm full width */
            }
            .control-group-right {
                justify-content: center; /* CƒÉn gi·ªØa c√°c n√∫t */
                width: 100%; /* Chi·∫øm full width ƒë·ªÉ c√°c n√∫t b√™n trong c√≥ th·ªÉ cƒÉn ch·ªânh */
                flex-wrap: wrap; /* Cho ph√©p n√∫t xu·ªëng d√≤ng n·∫øu kh√¥ng ƒë·ªß ch·ªó */
            }
             h1 {
                 font-size: 1.5em;
             }
             button, select {
                 /* Adjust button/select width slightly less than 100% on small screens if needed, or keep 100% */
                 width: 100%; /* N√∫t/Select chi·∫øm full width */
                 box-sizing: border-box;
                 justify-content: center; /* CƒÉn gi·ªØa n·ªôi dung n√∫t */
                 margin-bottom: 5px; /* Add some space between stacked controls */
             }
             .control-group {
                 justify-content: space-between; /* Label v√† select c√°ch xa nhau */
                 width: 100%; /* Ensure control group takes full width */
                 margin-bottom: 5px;
             }
             .control-group-right button {
                 width: calc(50% - 5px); /* Make Run/Clear buttons roughly half-width with a gap */
             }
             .control-group-right button:first-child {
                 margin-right: 10px; /* Space between Clear and Run */
             }

             .CodeMirror {
                 font-size: 13px;
             }
             #output {
                 font-size: 0.85em;
             }
        }
         /* Responsive adjustment for slightly larger screens where controls might wrap awkwardly */
         @media (max-width: 768px) and (min-width: 601px) {
            .controls {
                 gap: 10px; /* Reduce gap slightly */
             }
            .control-group-right {
                 margin-left: auto; /* Push right group to the right */
             }
         }


    </style>
</head>
<body>

<div class="container">
    <h1>Tr√¨nh bi√™n d·ªãch C/C++ Online</h1>

    <div class="controls">
        <div class="control-group">
            <label for="language">Ng√¥n ng·ªØ:</label>
            <select id="language">
                <option value="cpp">C++</option>
                <option value="c">C</option>
            </select>
        </div>
         <div class="control-group-right">
             <button id="clearButton">
                 üßπ¬†Clear Code
             </button>
            <button id="runButton">
                <span id="runSpinner" class="loader"></span>
                <span class="run-icon">‚ñ∂</span>¬†
                <span id="runButtonText">Run Code</span>
            </button>
        </div>
    </div>

    <div id="statusMessage"></div>

    <div class="editor-container">
        <!-- Textarea g·ªëc, CodeMirror s·∫Ω thay th·∫ø n√≥ -->
        <textarea id="code" placeholder="Nh·∫≠p code C/C++ c·ªßa b·∫°n ·ªü ƒë√¢y..." spellcheck="false"></textarea>
    </div>

    <div class="output-container">
        <div class="output-header">
            <h3>K·∫øt qu·∫£:</h3>
        </div>
        <pre id="output">Ch∆∞a c√≥ k·∫øt qu·∫£...</pre>
    </div>

    <div class="footer">
        <p>Design by <span class="author">Tr√°c Tu·∫•n Ki·ªát</span> | S·ª≠ d·ª•ng Piston API</p>
        <p class="api-note">
            <a href="https://github.com/engineer-man/piston" target="_blank" rel="noopener noreferrer">Piston API</a> |
            <a href="https://emkc.org/api/v2/piston/runtimes" target="_blank" rel="noopener noreferrer" id="runtimeLink">Xem Runtimes H·ªó Tr·ª£</a>
            <span class="runtime-warning"><-- T·ª± ƒë·ªông t√¨m phi√™n b·∫£n m·ªõi nh·∫•t.</span>
        </p>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.js"></script>


<script>
    // --- JavaScript ---
    const languageSelect = document.getElementById('language');
    const codeArea = document.getElementById('code'); // Textarea g·ªëc
    const runButton = document.getElementById('runButton');
    const clearButton = document.getElementById('clearButton');
    const outputArea = document.getElementById('output');
    const statusMessage = document.getElementById('statusMessage');
    const runSpinner = document.getElementById('runSpinner');
    const runButtonText = document.getElementById('runButtonText');
    const runtimeLink = document.getElementById('runtimeLink');

    const PISTON_API_URL_EXECUTE = 'https://emkc.org/api/v2/piston/execute';
    const PISTON_API_URL_RUNTIMES = 'https://emkc.org/api/v2/piston/runtimes';

    let availableRuntimes = null;
    let editor = null; // Bi·∫øn ƒë·ªÉ gi·ªØ instance c·ªßa CodeMirror

    // --- H√†m hi·ªÉn th·ªã th√¥ng b√°o ---
    function showMessage(message, type = 'info', duration = null) {
        statusMessage.textContent = message;
        statusMessage.className = type; // ƒê·∫∑t class ƒë·ªÉ CSS x·ª≠ l√Ω m√†u s·∫Øc
        statusMessage.style.display = 'block';

        // T·ª± ƒë·ªông ·∫©n n·∫øu c√≥ duration
        if (duration && typeof duration === 'number') {
            setTimeout(() => {
                // Ch·ªâ ·∫©n n·∫øu n·ªôi dung th√¥ng b√°o kh√¥ng thay ƒë·ªïi
                if (statusMessage.textContent === message) {
                    statusMessage.style.display = 'none';
                }
            }, duration);
        }
    }

     // --- H√†m x√≥a tr·∫°ng th√°i v√† output ---
    function clearStatusAndOutput() {
        // Ch·ªâ x√≥a c√°c th√¥ng b√°o kh√¥ng ph·∫£i l√† th√¥ng b√°o ƒëang l·∫•y runtime
        if (!statusMessage.textContent.startsWith("ƒêang l·∫•y") && !statusMessage.textContent.startsWith("L·∫•y danh s√°ch")) {
             statusMessage.style.display = 'none';
             statusMessage.textContent = ''; // X√≥a h·∫≥n n·ªôi dung
             statusMessage.className = ''; // X√≥a class
        }
        outputArea.textContent = 'Ch∆∞a c√≥ k·∫øt qu·∫£...';
        outputArea.classList.remove('error-output', 'invalid-version-error');
    }


    // --- L·∫•y v√† cache danh s√°ch runtimes ---
    async function fetchAndCacheRuntimes() {
        if (availableRuntimes) return availableRuntimes;
        showMessage("ƒêang l·∫•y danh s√°ch phi√™n b·∫£n h·ªó tr·ª£...", "info");
        try {
            const response = await fetch(PISTON_API_URL_RUNTIMES);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const runtimes = await response.json();
            // S·∫Øp x·∫øp runtimes theo version gi·∫£m d·∫ßn ƒë·ªÉ d·ªÖ l·∫•y c√°i m·ªõi nh·∫•t
             runtimes.sort((a, b) => {
                const verA = (a.version || '0').split('.').map(Number);
                const verB = (b.version || '0').split('.').map(Number);
                for (let i = 0; i < Math.max(verA.length, verB.length); i++) {
                    const numA = verA[i] || 0;
                    const numB = verB[i] || 0;
                    if (numA < numB) return 1; // b l·ªõn h∆°n -> b ƒë·ª©ng tr∆∞·ªõc
                    if (numA > numB) return -1; // a l·ªõn h∆°n -> a ƒë·ª©ng tr∆∞·ªõc
                }
                return 0; // B·∫±ng nhau
             });
            availableRuntimes = runtimes;
            console.log("Danh s√°ch Runtimes ƒë√£ ƒë∆∞·ª£c l·∫•y v√† s·∫Øp x·∫øp:", availableRuntimes);
            showMessage("L·∫•y danh s√°ch phi√™n b·∫£n th√†nh c√¥ng.", "success", 2500); // T·ª± ·∫©n sau 2.5s
            return availableRuntimes;
        } catch (error) {
            console.error("L·ªói khi l·∫•y runtimes:", error);
            showMessage(`L·ªói khi l·∫•y danh s√°ch phi√™n b·∫£n: ${error.message}. S·ª≠ d·ª•ng phi√™n b·∫£n m·∫∑c ƒë·ªãnh (c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông).`, "error");
            availableRuntimes = []; // ƒê√°nh d·∫•u l√† ƒë√£ th·ª≠ nh∆∞ng l·ªói
            return [];
        }
    }

    // --- T√¨m phi√™n b·∫£n h·ª£p l·ªá m·ªõi nh·∫•t ---
    function findLatestVersion(language) {
        if (!availableRuntimes || availableRuntimes.length === 0) {
            console.warn(`Kh√¥ng c√≥ danh s√°ch runtimes, kh√¥ng th·ªÉ t√¨m version cho ${language}`);
            return null;
        }
        // ∆Øu ti√™n kh·ªõp ch√≠nh x√°c language tr∆∞·ªõc, sau ƒë√≥ ƒë·∫øn aliases
        const matchingRuntimes = availableRuntimes.filter(rt =>
             rt.language === language || (rt.aliases && rt.aliases.includes(language))
        );

        if (matchingRuntimes.length > 0) {
            // Do ƒë√£ s·∫Øp x·∫øp gi·∫£m d·∫ßn, ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n l√† m·ªõi nh·∫•t
            console.log(`T√¨m th·∫•y version ${matchingRuntimes[0].version} cho ${language}`);
            return matchingRuntimes[0].version;
        }
        console.warn(`Kh√¥ng t√¨m th·∫•y runtime n√†o cho ${language}`);
        return null;
    }

    // --- C·∫≠p nh·∫≠t code m·∫´u v√† mode editor ---
    function updateSampleCodeAndMode() {
        const selectedLang = languageSelect.value;
        let sampleCode = '';
        let editorMode = 'text/x-c++src'; // M·∫∑c ƒë·ªãnh l√† C++

        // L·∫•y version (ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã trong code m·∫´u)
        const version = findLatestVersion(selectedLang) || 's·∫Ω t·ª± ƒë·ªông t√¨m';

        if (selectedLang === 'c') {
            sampleCode = `#include <stdio.h>\n\nint main() {\n    /* Code C c·ªßa b·∫°n ·ªü ƒë√¢y */\n    printf("Xin ch√†o t·ª´ C (runtime: ${version})!\\n");\n    return 0;\n}`;
            editorMode = 'text/x-csrc';
        } else { // cpp
            sampleCode = `#include <iostream>\n#include <string>\n\nint main() {\n    /* Code C++ c·ªßa b·∫°n ·ªü ƒë√¢y */\n    std::string msg = "Xin ch√†o t·ª´ C++";\n    std::cout << msg << " (runtime: ${version})!" << std::endl;\n    int a = 15, b = 27;\n    std::cout << a << " + " << b << " = " << (a + b) << std::endl;\n    return 0;\n}`;
            editorMode = 'text/x-c++src';
        }

        if (editor) {
            // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu editor ƒëang tr·ªëng ho·∫∑c l√† code m·∫´u c≈©
            const currentCode = editor.getValue();
            const isDefaultOrEmpty = currentCode.trim() === '' || currentCode.includes("Xin ch√†o t·ª´ C") || currentCode.includes("Xin ch√†o t·ª´ C++");

            if(isDefaultOrEmpty) {
                editor.setValue(sampleCode);
            }
            // Lu√¥n c·∫≠p nh·∫≠t mode
            editor.setOption("mode", editorMode);
             console.log(`ƒê√£ ƒë·∫∑t mode editor th√†nh: ${editorMode}`);
             editor.refresh(); // ƒê·∫£m b·∫£o editor v·∫Ω l·∫°i ƒë√∫ng c√°ch sau khi thay ƒë·ªïi mode/n·ªôi dung
        }
        clearStatusAndOutput(); // X√≥a output c≈© khi ƒë·ªïi ng√¥n ng·ªØ
    }

    // --- Kh·ªüi t·∫°o khi trang t·∫£i xong ---
    window.onload = async () => {
         // Kh·ªüi t·∫°o CodeMirror t·ª´ textarea g·ªëc
         editor = CodeMirror.fromTextArea(codeArea, {
            lineNumbers: true,
            mode: "text/x-c++src", // Mode ban ƒë·∫ßu
            theme: "dracula",
            matchBrackets: true,
            autoCloseBrackets: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            // lineWrapping: true, // B·∫≠t n·∫øu mu·ªën t·ª± ƒë·ªông xu·ªëng d√≤ng
        });

        // ƒê·∫£m b·∫£o editor chi·∫øm h·∫øt chi·ªÅu cao container
        // Element th·ª±c s·ª± c·ªßa editor l√† editor.getWrapperElement()
        // ƒê·∫∑t size cho element wrapper n√†y
        editor.getWrapperElement().style.height = "100%";
        editor.getWrapperElement().style.flexGrow = "1"; // ƒê·∫£m b·∫£o n√≥ fill trong flex container

        await fetchAndCacheRuntimes(); // L·∫•y runtimes tr∆∞·ªõc
        updateSampleCodeAndMode(); // C·∫≠p nh·∫≠t code m·∫´u v√† mode d·ª±a tr√™n select ban ƒë·∫ßu

        // Refresh editor sau khi m·ªçi th·ª© ƒë√£ ·ªïn ƒë·ªãnh (ƒë√¥i khi c·∫ßn thi·∫øt)
        setTimeout(() => {
            editor.refresh();
        }, 1);
    };

    // --- X·ª≠ l√Ω s·ª± ki·ªán ---
    languageSelect.addEventListener('change', updateSampleCodeAndMode);

    // N√∫t Clear Code
    clearButton.addEventListener('click', () => {
        if (editor) {
            editor.setValue(''); // X√≥a n·ªôi dung editor
            editor.focus(); // ƒê∆∞a con tr·ªè v√†o editor
            showMessage("ƒê√£ x√≥a n·ªôi dung code.", "info", 2000); // Th√¥ng b√°o ng·∫Øn
        }
    });

    // N√∫t Run Code
    runButton.addEventListener('click', async () => {
        if (!editor) {
            showMessage('Tr√¨nh so·∫°n th·∫£o ch∆∞a s·∫µn s√†ng!', 'error');
            return;
        }
        const code = editor.getValue(); // L·∫•y code t·ª´ CodeMirror
        const language = languageSelect.value;

        if (!code.trim()) {
            showMessage('Vui l√≤ng nh·∫≠p code tr∆∞·ªõc khi ch·∫°y.', 'error');
            editor.focus();
            return;
        }

        // --- B·∫Øt ƒë·∫ßu tr·∫°ng th√°i ch·∫°y ---
        runButton.disabled = true;
        clearButton.disabled = true; // V√¥ hi·ªáu h√≥a c·∫£ n√∫t Clear
        runButton.classList.add('running');
        runButtonText.textContent = 'ƒêang ch·∫°y...';
        clearStatusAndOutput(); // X√≥a output c≈© v√† th√¥ng b√°o (tr·ª´ th√¥ng b√°o runtime n·∫øu c√≤n)
        outputArea.textContent = `ƒêang t√¨m phi√™n b·∫£n ${language} h·ª£p l·ªá...`;
        // ---

        // ƒê·∫£m b·∫£o ƒë√£ l·∫•y runtimes (th∆∞·ªùng ƒë√£ c√≥ t·ª´ onload)
        await fetchAndCacheRuntimes();

        const version = findLatestVersion(language);

        if (!version) {
            const errorMsg = `Kh√¥ng t√¨m th·∫•y phi√™n b·∫£n h·ª£p l·ªá n√†o cho '${language}' t·ª´ Piston API. Kh√¥ng th·ªÉ ch·∫°y code.`;
            showMessage(errorMsg, 'error');
            outputArea.textContent = `L·ªói: Kh√¥ng t√¨m th·∫•y phi√™n b·∫£n '${language}' n√†o ƒëang ho·∫°t ƒë·ªông tr√™n Piston API.\nH√£y th·ª≠ ki·ªÉm tra l·∫°i link 'Xem Runtimes H·ªó Tr·ª£'.`;
            outputArea.classList.add('error-output', 'invalid-version-error');
            // D·ª´ng tr·∫°ng th√°i ch·∫°y (trong tr∆∞·ªùng h·ª£p l·ªói n√†y)
             runButton.disabled = false;
             clearButton.disabled = false;
             runButton.classList.remove('running');
             runButtonText.textContent = 'Run Code';
            return;
        }

        outputArea.textContent = `ƒêang g·ª≠i code ${language} (phi√™n b·∫£n ${version}) ƒë·∫øn Piston API...`;

        try {
            const response = await fetch(PISTON_API_URL_EXECUTE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    language: language,
                    version: version,
                    files: [{ content: code }],
                    // stdin: "", // C√≥ th·ªÉ th√™m input n·∫øu c·∫ßn
                    // args: [], // C√≥ th·ªÉ th√™m ƒë·ªëi s·ªë d√≤ng l·ªánh n·∫øu c·∫ßn
                })
            });

            const responseText = await response.text(); // L·∫•y text tr∆∞·ªõc ƒë·ªÉ parse an to√†n

            if (!response.ok) {
                 let errorDetail = `M√£ l·ªói HTTP: ${response.status}`;
                 let isStillInvalidVersion = false;
                 let apiMessage = response.statusText; // M·∫∑c ƒë·ªãnh

                 try {
                     const errorJson = JSON.parse(responseText);
                     apiMessage = errorJson.message || apiMessage;
                     if (apiMessage && typeof apiMessage === 'string' && apiMessage.toLowerCase().includes("runtime is unknown")) {
                         isStillInvalidVersion = true;
                     }
                 } catch (e) {
                     // responseText kh√¥ng ph·∫£i JSON h·ª£p l·ªá
                      if (typeof responseText === 'string' && responseText.toLowerCase().includes("runtime is unknown")) {
                         isStillInvalidVersion = true;
                     }
                     apiMessage += `. Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON: ${responseText.substring(0, 100)}...`; // Hi·ªÉn th·ªã m·ªôt ph·∫ßn n·∫øu kh√¥ng ph·∫£i JSON
                 }

                 errorDetail += ` - ${apiMessage}`;

                 if (isStillInvalidVersion) {
                      errorDetail += `\n\n>>> L·ªñI KH√îNG MONG MU·ªêN <<<\nD√π ƒë√£ t·ª± ƒë·ªông t√¨m th·∫•y phi√™n b·∫£n '${version}' cho '${language}', Piston API v·∫´n b√°o phi√™n b·∫£n n√†y kh√¥ng h·ª£p l·ªá.\nC√≥ th·ªÉ API ƒëang g·∫∑p s·ª± c·ªë ho·∫∑c phi√™n b·∫£n v·ª´a b·ªã g·ª° b·ªè.\nH√£y th·ª≠ l·∫°i sau ho·∫∑c ki·ªÉm tra l·∫°i link 'Xem Runtimes H·ªó Tr·ª£'.`;
                      outputArea.classList.add('invalid-version-error');
                      availableRuntimes = null; // X√≥a cache runtimes ƒë·ªÉ th·ª≠ l·∫•y l·∫°i l·∫ßn sau
                      // Fetch l·∫°i runtimes ngay l·∫≠p t·ª©c ƒë·ªÉ th·ª≠ c·∫≠p nh·∫≠t
                      fetchAndCacheRuntimes();
                 }

                 throw new Error(`L·ªói k·∫øt n·ªëi ho·∫∑c y√™u c·∫ßu kh√¥ng h·ª£p l·ªá t·ªõi Piston API.\n${errorDetail}`);
            }

            // N·∫øu th√†nh c√¥ng, x√≥a class l·ªói version (n·∫øu c√≥ t·ª´ l·∫ßn ch·∫°y tr∆∞·ªõc)
            outputArea.classList.remove('invalid-version-error');

            const result = JSON.parse(responseText);
            console.log("K·∫øt qu·∫£ t·ª´ Piston API:", result); // Log ƒë·ªÉ debug

            let finalOutput = "";
            let hasError = false;

            // X·ª≠ l√Ω output/error t·ª´ Compile (n·∫øu c√≥)
             if (result.compile) {
                if (result.compile.stdout) {
                     finalOutput += "--- Compile Output ---\n";
                     finalOutput += result.compile.stdout.trim() + "\n\n";
                 }
                 if (result.compile.stderr) {
                     finalOutput += "--- L·ªói Bi√™n D·ªãch (Compile Error) ---\n";
                     finalOutput += result.compile.stderr.trim() + "\n\n";
                     hasError = true;
                 }
             } else {
                 console.log("Kh√¥ng c√≥ th√¥ng tin 'compile' trong k·∫øt qu·∫£.");
             }


            // X·ª≠ l√Ω output/error t·ª´ Run
            if (result.run) {
                if (result.run.stdout || result.run.stdout === "") { // stdout c√≥ th·ªÉ l√† chu·ªói r·ªóng
                     finalOutput += (finalOutput.length > 0 && !hasError) ? "--- Output ---\n" : ""; // Th√™m header ch·ªâ khi c√≥ compile output v√† kh√¥ng c√≥ l·ªói compile
                     finalOutput += result.run.stdout.trim() || (hasError ? "" : "(Ch∆∞∆°ng tr√¨nh ch·∫°y th√†nh c√¥ng nh∆∞ng kh√¥ng c√≥ output)");
                }
                 if (result.run.stderr) {
                     finalOutput += (finalOutput.length > 0 ? "\n\n" : "") + "--- L·ªói Runtime (Runtime Error) ---\n";
                     finalOutput += result.run.stderr.trim();
                     hasError = true;
                 }
                 if(result.run.signal) {
                     finalOutput += `\n--- Ch∆∞∆°ng tr√¨nh k·∫øt th√∫c b·ªüi t√≠n hi·ªáu: ${result.run.signal} (Code: ${result.run.code}) ---`;
                     hasError = true;
                 }
            } else if (!hasError) {
                finalOutput += "Ph·∫£n h·ªìi t·ª´ API kh√¥ng ch·ª©a k·∫øt qu·∫£ th·ª±c thi ('run').";
            }

             outputArea.textContent = finalOutput.trim() || "(Kh√¥ng c√≥ output n√†o ƒë∆∞·ª£c ghi nh·∫≠n)"; // ƒê·∫£m b·∫£o lu√¥n c√≥ g√¨ ƒë√≥ hi·ªÉn th·ªã

            if (hasError) {
                outputArea.classList.add('error-output');
                showMessage('C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh bi√™n d·ªãch ho·∫∑c ch·∫°y.', 'error');
            } else {
                outputArea.classList.remove('error-output');
                showMessage('Ch∆∞∆°ng tr√¨nh ƒë√£ ch·∫°y xong.', 'success', 3000); // T·ª± ·∫©n sau 3s
            }

        } catch (error) {
            console.error('L·ªói trong qu√° tr√¨nh ch·∫°y code:', error);
            // Kh√¥ng ghi ƒë√® n·∫øu l√† l·ªói invalid-version ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ƒë·∫∑c bi·ªát ·ªü tr√™n
            if (!outputArea.classList.contains('invalid-version-error')) {
                 outputArea.textContent = `ƒê√£ x·∫£y ra l·ªói:\n\n${error.message}`;
                 outputArea.classList.add('error-output');
             }
            showMessage('Kh√¥ng th·ªÉ ho√†n th√†nh y√™u c·∫ßu. Ki·ªÉm tra output ƒë·ªÉ bi·∫øt chi ti·∫øt.', 'error');
        } finally {
            // --- D·ª´ng tr·∫°ng th√°i ch·∫°y ---
            runButton.disabled = false;
            clearButton.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t Clear
            runButton.classList.remove('running');
            runButtonText.textContent = 'Run Code'; // ƒê·∫∑t l·∫°i t√™n n√∫t
            // ---
        }
    });

</script>

</body>
</html>